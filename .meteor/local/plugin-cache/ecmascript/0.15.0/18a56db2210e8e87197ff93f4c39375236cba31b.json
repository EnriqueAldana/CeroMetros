{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/enrique/DiscoDeEnrique/2021/Proyectos/CeroMetros/imports/api/Products/ProductCtl.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.x86_64"},"sourceFileName":"imports/api/Products/ProductCtl.js","filename":"/Users/enrique/DiscoDeEnrique/2021/Proyectos/CeroMetros/imports/api/Products/ProductCtl.js","cloneInputAst":true,"passPerPreset":false,"envName":"development","cwd":"/Users/enrique/DiscoDeEnrique/2021/Proyectos/CeroMetros","root":"/Users/enrique/DiscoDeEnrique/2021/Proyectos/CeroMetros","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.12.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":{},"_verified":{},"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/enrique/DiscoDeEnrique/2021/Proyectos/CeroMetros/imports/api/Products/ProductCtl.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/api/Products/ProductCtl.js"}},"code":"let ValidatedMethod;\nmodule.link(\"meteor/mdg:validated-method\", {\n  ValidatedMethod(v) {\n    ValidatedMethod = v;\n  }\n\n}, 0);\nlet ResponseMessage;\nmodule.link(\"../../startup/server/utilities/ResponseMesssage\", {\n  ResponseMessage(v) {\n    ResponseMessage = v;\n  }\n\n}, 1);\nlet AuthGuard;\nmodule.link(\"../../middlewares/AuthGuard\", {\n  default(v) {\n    AuthGuard = v;\n  }\n\n}, 2);\nlet Permissions;\nmodule.link(\"../../startup/server/Permissions\", {\n  default(v) {\n    Permissions = v;\n  }\n\n}, 3);\nlet Product;\nmodule.link(\"./Product\", {\n  Product(v) {\n    Product = v;\n  }\n\n}, 4);\nlet ProductServ;\nmodule.link(\"./ProductServ\", {\n  default(v) {\n    ProductServ = v;\n  }\n\n}, 5);\nlet check, Match;\nmodule.link(\"meteor/check\", {\n  check(v) {\n    check = v;\n  },\n\n  Match(v) {\n    Match = v;\n  }\n\n}, 6);\nnew ValidatedMethod({\n  name: 'product.save',\n  mixins: [MethodHooks],\n  permissions: [Permissions.PRODUCTS.CREATE.VALUE, Permissions.PRODUCTS.UPDATE.VALUE],\n  beforeHooks: [AuthGuard.checkPermission],\n\n  validate(product) {\n    try {\n      console.info('product ', product);\n      check(product, {\n        _id: Match.OneOf(String, null),\n        name: String,\n        name_full: String,\n        unit: {\n          _id: String,\n          name: String\n        },\n        stock: String,\n        provider: {\n          _id: String,\n          name: String\n        },\n        location: String,\n        sku: String,\n        warehouse: {\n          _id: String,\n          name: String,\n          name_full: String,\n          location: String\n        },\n        production_line: {\n          _id: String,\n          description: String,\n          name: String,\n          workstations: [{\n            _id: String,\n            name: String,\n            name_full: String,\n            location: String,\n            productionline: {\n              description: String,\n              name: String,\n              _id: String\n            }\n          }]\n        },\n        bom: [{\n          _id: Match.OneOf(String, null),\n          name: Match.OneOf(String, null),\n          quantity: Match.OneOf(String, null)\n        }],\n        isAvailable: Boolean\n      });\n    } catch (exception) {\n      console.error('product.save', exception);\n      throw new Meteor.Error('403', 'La informacion introducida no es valida');\n    } // Validar que no haya producto con el mismo nombre\n\n\n    ProductServ.validateProductName(product.name, product._id);\n  },\n\n  run(product) {\n    const responseMessage = new ResponseMessage();\n\n    try {\n      if (product._id !== null) {\n        // ToDO\n        // agregar registro en kardex si se ha cambiado el valor de stock\n        Product.update(product._id, {\n          $set: {\n            name: product.name,\n            name_full: product.name_full,\n            unit: product.unit,\n            stock: product.stock,\n            location: product.location,\n            sku: product.sku,\n            warehouse: product.warehouse,\n            production_line: product.production_line,\n            provider: product.provider,\n            bom: product.bomList,\n            isAvailable: product.isAvailable\n          }\n        });\n        responseMessage.create('Se actualizó la empresa exitosamente');\n      } else {\n        Product.insert({\n          name: product.name,\n          name_full: product.name_full,\n          unit: product.unit,\n          stock: product.stock,\n          location: product.location,\n          sku: product.sku,\n          warehouse: product.warehouse,\n          production_line: product.production_line,\n          provider: product.provider,\n          bom: product.bomList,\n          isAvailable: product.isAvailable\n        });\n        responseMessage.create('Se insertó el producto exitosamente');\n      }\n    } catch (exception) {\n      console.error('product.save', exception);\n      throw new Meteor.Error('500', 'Ha ocurrido un error al guardar el producto');\n    }\n\n    return responseMessage;\n  }\n\n});\nnew ValidatedMethod({\n  name: 'product.delete',\n  mixins: [MethodHooks],\n  permissions: [Permissions.PRODUCTS.DELETE.VALUE],\n  beforeHooks: [AuthGuard.checkPermission],\n  // Aqui se verifica si los permisos de usuario son adecuados para esta accion\n  afterHooks: [],\n\n  validate(_ref) {\n    let {\n      idProduct\n    } = _ref;\n\n    try {\n      check(idProduct, String);\n    } catch (exception) {\n      console.error('product.delete', exception);\n      throw new Meteor.Error('403', 'Ocurrio un error al eliminar el producto');\n    } // validar que no sea posible eliminar un producto si hay un almacen utilizandolo.\n    // ToDo\n\n\n    const isUseredByWarehouse = 0; //CompanyServ.getUsersBycompany(idCompany);\n\n    if (isUseredByWarehouse.length > 0) {\n      throw new Meteor.Error('403', 'No es posible elimiar el producto', 'Hay al menos un almacen utilizando el producto');\n    }\n  },\n\n  run(_ref2) {\n    let {\n      idProduct\n    } = _ref2;\n    const responseMessage = new ResponseMessage();\n\n    try {\n      Product.remove(idProduct);\n      responseMessage.create('Producto eliminado exitosamente');\n    } catch (exception) {\n      console.error('product.delete', exception);\n      throw new Meteor.Error('500', 'Ocurrio un error al eliminar el producto');\n    }\n\n    return responseMessage;\n  }\n\n});","map":{"version":3,"sources":["imports/api/Products/ProductCtl.js"],"names":["ValidatedMethod","module","link","v","ResponseMessage","AuthGuard","default","Permissions","Product","ProductServ","check","Match","name","mixins","MethodHooks","permissions","PRODUCTS","CREATE","VALUE","UPDATE","beforeHooks","checkPermission","validate","product","console","info","_id","OneOf","String","name_full","unit","stock","provider","location","sku","warehouse","production_line","description","workstations","productionline","bom","quantity","isAvailable","Boolean","exception","error","Meteor","Error","validateProductName","run","responseMessage","update","$set","bomList","create","insert","DELETE","afterHooks","idProduct","isUseredByWarehouse","length","remove"],"mappings":"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","sourcesContent":["import {ValidatedMethod} from 'meteor/mdg:validated-method';\nimport {ResponseMessage} from \"../../startup/server/utilities/ResponseMesssage\";\nimport AuthGuard from \"../../middlewares/AuthGuard\";\nimport Permissions from \"../../startup/server/Permissions\";\nimport {Product} from \"./Product\";\nimport ProductServ from \"./ProductServ\";\nimport {check, Match} from \"meteor/check\";\n\nnew ValidatedMethod({\n    name:'product.save',\n     mixins:[MethodHooks],\n     permissions: [Permissions.PRODUCTS.CREATE.VALUE,Permissions.PRODUCTS.UPDATE.VALUE],  \n     beforeHooks: [AuthGuard.checkPermission],\n    validate(product){\n        try {\n            console.info('product ', product)\n            check(product,{\n                _id: Match.OneOf(String, null),\n                name: String,\n                name_full: String,\n                unit: {\n                    _id: String,\n                    name: String\n                },\n                stock: String\n                ,\n                provider: {\n                    _id: String,\n                    name: String\n                },\n                location: String,\n                sku: String,\n                warehouse: {\n                    _id: String,\n                    name: String,\n                    name_full: String,\n                    location: String\n                },\n                production_line: {\n                    _id: String,\n                    description: String,\n                    name: String,\n                    workstations: [\n                        {\n                            _id: String,\n                            name: String,\n                            name_full: String,\n                            location: String,\n                            productionline: {\n                                description : String,\n                                name : String,\n                                _id : String\n                            }\n                        }\n                    ]\n                }\n                ,\n                bom:[\n                        {\n                            _id: Match.OneOf(String, null),\n                            name: Match.OneOf(String, null),\n                            quantity: Match.OneOf(String, null)\n                            \n                        }\n                    ],\n                isAvailable: Boolean\n            });\n\n        }catch ( exception){\n            console.error('product.save', exception);\n            throw new Meteor.Error('403', 'La informacion introducida no es valida');\n        }\n        // Validar que no haya producto con el mismo nombre\n        ProductServ.validateProductName(product.name,product._id);\n    },\n    run(product){\n        const responseMessage = new ResponseMessage(); \n        try {\n            if(product._id !== null){\n                // ToDO\n                // agregar registro en kardex si se ha cambiado el valor de stock\n                Product.update(product._id,{\n                    $set: {\n                    name: product.name,\n                    name_full: product.name_full,\n                    unit: product.unit,\n                    stock: product.stock,\n                    location: product.location,\n                    sku: product.sku,\n                    warehouse: product.warehouse,\n                    production_line: product.production_line,\n                    provider: product.provider,\n                    bom:    product.bomList,\n                    isAvailable: product.isAvailable\n                    }\n                });\n                responseMessage.create('Se actualizó la empresa exitosamente');\n            }else{\n                Product.insert({\n                    name: product.name,\n                    name_full: product.name_full,\n                    unit: product.unit,\n                    stock: product.stock,\n                    location: product.location,\n                    sku: product.sku,\n                    warehouse: product.warehouse,\n                    production_line: product.production_line,\n                    provider: product.provider,\n                    bom:    product.bomList,\n                    isAvailable: product.isAvailable\n                });\n                responseMessage.create('Se insertó el producto exitosamente');\n            }\n        }catch ( exception){\n            console.error('product.save', exception);\n            throw new Meteor.Error('500', 'Ha ocurrido un error al guardar el producto');\n        }\n        return responseMessage;\n    }\n });\n\nnew ValidatedMethod({\n    name: 'product.delete',\n    mixins: [MethodHooks],\n    permissions: [Permissions.PRODUCTS.DELETE.VALUE],\n    beforeHooks: [AuthGuard.checkPermission],  // Aqui se verifica si los permisos de usuario son adecuados para esta accion\n    afterHooks: [],\n    validate({ idProduct }){\n        try {\n            check(idProduct, String);\n        }catch (exception) {\n            console.error('product.delete', exception);\n            throw new Meteor.Error('403', 'Ocurrio un error al eliminar el producto');\n        }\n        // validar que no sea posible eliminar un producto si hay un almacen utilizandolo.\n        // ToDo\n        const isUseredByWarehouse = 0;\n        //CompanyServ.getUsersBycompany(idCompany);\n\n        if (isUseredByWarehouse.length > 0){\n            throw new Meteor.Error('403','No es posible elimiar el producto',\n                'Hay al menos un almacen utilizando el producto');\n        }\n    },\n    run({ idProduct }){\n        const responseMessage = new ResponseMessage();\n        try {\n            Product.remove(idProduct);\n                responseMessage.create('Producto eliminado exitosamente');\n        }catch (exception) {\n            console.error('product.delete', exception);\n            throw new Meteor.Error('500', 'Ocurrio un error al eliminar el producto');\n        }\n\n        return responseMessage;\n    }\n});\n"]},"sourceType":"module","hash":"18a56db2210e8e87197ff93f4c39375236cba31b"}
