{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/enrique/DiscoDeEnrique/2021/Proyectos/CeroMetros/imports/api/Profiles/ProfileCtl.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.x86_64"},"sourceFileName":"imports/api/Profiles/ProfileCtl.js","filename":"/Users/enrique/DiscoDeEnrique/2021/Proyectos/CeroMetros/imports/api/Profiles/ProfileCtl.js","cloneInputAst":true,"passPerPreset":false,"envName":"development","cwd":"/Users/enrique/DiscoDeEnrique/2021/Proyectos/CeroMetros","root":"/Users/enrique/DiscoDeEnrique/2021/Proyectos/CeroMetros","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.12.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":{},"_verified":{},"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/enrique/DiscoDeEnrique/2021/Proyectos/CeroMetros/imports/api/Profiles/ProfileCtl.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/api/Profiles/ProfileCtl.js"}},"code":"let check, Match;\nmodule.link(\"meteor/check\", {\n  check(v) {\n    check = v;\n  },\n\n  Match(v) {\n    Match = v;\n  }\n\n}, 0);\nlet Profile;\nmodule.link(\"./Profile\", {\n  Profile(v) {\n    Profile = v;\n  }\n\n}, 1);\nlet ResponseMessage;\nmodule.link(\"../../startup/server/utilities/ResponseMesssage\", {\n  ResponseMessage(v) {\n    ResponseMessage = v;\n  }\n\n}, 2);\nlet ProfileServ;\nmodule.link(\"./ProfilesServ\", {\n  default(v) {\n    ProfileServ = v;\n  }\n\n}, 3);\nlet Permissions;\nmodule.link(\"../../startup/server/Permissions\", {\n  default(v) {\n    Permissions = v;\n  }\n\n}, 4);\nlet AuthGuard;\nmodule.link(\"../../middlewares/AuthGuard\", {\n  default(v) {\n    AuthGuard = v;\n  }\n\n}, 5);\nnew ValidatedMethod({\n  name: 'profile.save',\n  mixins: [MethodHooks],\n  permissions: [Permissions.PROFILES.CREATE.VALUE, Permissions.PROFILES.UPDATE.VALUE],\n  beforeHooks: [AuthGuard.checkPermission],\n  // Aqui se verifica si los permisos de usuario son adecuados para esta accion\n  afterHooks: [],\n\n  validate(profile) {\n    try {\n      // Valida que la estructura del objeto user este conforme a la definicion.\n      check(profile, {\n        _id: Match.OneOf(String, null),\n        name: String,\n        description: String,\n        permissions: [String]\n      });\n    } catch (exception) {\n      console.error('profile.save', exception);\n      throw new Meteor.Error('403', 'La informacion introducida no es válida.');\n    }\n\n    ProfileServ.validateProfileName(profile.name, profile._id);\n  },\n\n  run(profile) {\n    console.log('profile.save');\n    const responseMessage = new ResponseMessage();\n\n    if (profile._id !== null) {\n      try {\n        const oldProfile = Profile.findOne(profile._id);\n        const users = ProfileServ.getUsersByprofile(profile._id);\n        Profile.update(profile._id, {\n          $set: {\n            name: profile.name,\n            description: profile.description,\n            permissions: profile.permissions\n          }\n        }); // Aqui debemos actualizar a los usuarios con el perfil anterior por el nuevo\n\n        if (oldProfile.name !== profile.name) {\n          Meteor.users.update({\n            'profile.profile': oldProfile.name\n          }, {\n            $set: {\n              'profile.profile': profile.name\n            }\n          }, {\n            multi: true\n          });\n        } // Actualizamos los permisos para el nuevo rol a todos los usuarios en la tabla de relacion\n        // role-assignment\n\n\n        ProfileServ.updateProfileUsers(users, profile);\n        console.log('Se ha actualizado el perfil');\n        responseMessage.create('Se ha actualizado el perfil');\n      } catch (exception) {\n        console.error('profile.save', exception);\n        throw new Meteor.Error('500', 'Ocurrió un error al actualizar el perfil');\n      }\n    } else {\n      console.log('perfil: ', profile);\n\n      try {\n        Profile.insert({\n          name: profile.name,\n          description: profile.description,\n          permissions: profile.permissions\n        });\n        console.log('Se ha guardado el perfil');\n        responseMessage.create('Se ha guardado el perfil');\n      } catch (exception) {\n        console.error('profile.save', exception);\n        throw new Meteor.Error('500', 'Ocurrió un error al guardar el perfil');\n      }\n    }\n\n    return responseMessage;\n  }\n\n});\nnew ValidatedMethod({\n  name: 'profile.delete',\n  mixins: [MethodHooks],\n  permissions: [Permissions.PROFILES.DELETE.VALUE],\n  beforeHooks: [AuthGuard.checkPermission],\n  // Aqui se verifica si los permisos de usuario son adecuados para esta accion\n  afterHooks: [],\n\n  validate(_ref) {\n    let {\n      idProfile\n    } = _ref;\n\n    try {\n      check(idProfile, String);\n    } catch (exception) {\n      console.error('profile.delete', exception);\n      throw new Meteor.Error('403', 'Ocurrio un error al eliminar el perfil');\n    } // validar que no sea posible eliminar un perfil si hay un usuario utilizandolo.\n\n\n    const userWithProfile = ProfileServ.getUsersByprofile(idProfile);\n    console.log('idProfile', idProfile);\n    console.log('userWithProfile', userWithProfile);\n\n    if (userWithProfile.length > 0) {\n      throw new Meteor.Error('403', 'No es posible elimiar el perfil', 'Hay al menos un usuario utilizando el perfil');\n    }\n  },\n\n  run(_ref2) {\n    let {\n      idProfile\n    } = _ref2;\n    const responseMessage = new ResponseMessage();\n\n    try {\n      Profile.remove(idProfile);\n      responseMessage.create('Perfil eliminado exitosamente');\n    } catch (exception) {\n      console.error('profile.delete', exception);\n      throw new Meteor.Error('500', 'Ocurrio un error al eliminar el perfil');\n    }\n\n    return responseMessage;\n  }\n\n});","map":{"version":3,"sources":["imports/api/Profiles/ProfileCtl.js"],"names":["check","Match","module","link","v","Profile","ResponseMessage","ProfileServ","default","Permissions","AuthGuard","ValidatedMethod","name","mixins","MethodHooks","permissions","PROFILES","CREATE","VALUE","UPDATE","beforeHooks","checkPermission","afterHooks","validate","profile","_id","OneOf","String","description","exception","console","error","Meteor","Error","validateProfileName","run","log","responseMessage","oldProfile","findOne","users","getUsersByprofile","update","$set","multi","updateProfileUsers","create","insert","DELETE","idProfile","userWithProfile","length","remove"],"mappings":"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","sourcesContent":["import {check, Match} from \"meteor/check\";\nimport {Profile} from \"./Profile\";\nimport {ResponseMessage} from \"../../startup/server/utilities/ResponseMesssage\";\nimport ProfileServ from \"./ProfilesServ\";\nimport Permissions from \"../../startup/server/Permissions\";\nimport AuthGuard from \"../../middlewares/AuthGuard\";\n\n\nnew ValidatedMethod({\n    name: 'profile.save',\n    mixins: [MethodHooks],\n    permissions: [Permissions.PROFILES.CREATE.VALUE,Permissions.PROFILES.UPDATE.VALUE],\n    beforeHooks: [AuthGuard.checkPermission],  // Aqui se verifica si los permisos de usuario son adecuados para esta accion\n    afterHooks: [],\n    validate(profile) {\n        try {\n            // Valida que la estructura del objeto user este conforme a la definicion.\n            check(profile, {\n                _id: Match.OneOf(String, null),\n                name: String,\n                description: String,\n                permissions: [String]\n            });\n        } catch (exception) {\n            console.error('profile.save', exception);\n            throw new Meteor.Error('403', 'La informacion introducida no es válida.');\n        }\n        ProfileServ.validateProfileName(profile.name,profile._id);\n    },\n    run(profile) {\n        console.log('profile.save');\n        const responseMessage= new ResponseMessage();\n        if(profile._id !==null){\n            try{\n                const oldProfile= Profile.findOne(profile._id);\n                const users = ProfileServ.getUsersByprofile(profile._id);\n                Profile.update(profile._id,{\n                    $set:{\n                        name: profile.name,\n                        description: profile.description,\n                        permissions: profile.permissions\n                    }\n                });\n                // Aqui debemos actualizar a los usuarios con el perfil anterior por el nuevo\n                if(oldProfile.name !== profile.name){\n                  Meteor.users.update({'profile.profile':oldProfile.name},{\n                          $set: {\n                                  'profile.profile': profile.name\n                          }\n                      },{multi: true})\n                }\n                // Actualizamos los permisos para el nuevo rol a todos los usuarios en la tabla de relacion\n                // role-assignment\n                ProfileServ.updateProfileUsers(users,profile);\n                console.log('Se ha actualizado el perfil');\n                responseMessage.create('Se ha actualizado el perfil');\n            }catch (exception) {\n                console.error('profile.save', exception);\n                throw new Meteor.Error('500', 'Ocurrió un error al actualizar el perfil');\n            }\n        }else{\n            console.log('perfil: ',profile);\n            try{\n                Profile.insert({\n                    name: profile.name,\n                    description: profile.description,\n                    permissions: profile.permissions\n                });\n                console.log('Se ha guardado el perfil');\n                responseMessage.create('Se ha guardado el perfil');\n            }catch (exception) {\n                console.error('profile.save', exception);\n                throw new Meteor.Error('500', 'Ocurrió un error al guardar el perfil');\n            }\n        }\n\n\n        return responseMessage;\n    }\n});\n\nnew ValidatedMethod({\n    name: 'profile.delete',\n    mixins: [MethodHooks],\n    permissions: [Permissions.PROFILES.DELETE.VALUE],\n    beforeHooks: [AuthGuard.checkPermission],  // Aqui se verifica si los permisos de usuario son adecuados para esta accion\n    afterHooks: [],\n    validate({ idProfile }){\n        try {\n            check(idProfile, String);\n        }catch (exception) {\n            console.error('profile.delete', exception);\n            throw new Meteor.Error('403', 'Ocurrio un error al eliminar el perfil');\n        }\n        // validar que no sea posible eliminar un perfil si hay un usuario utilizandolo.\n        const userWithProfile = ProfileServ.getUsersByprofile(idProfile);\n        console.log('idProfile', idProfile);\n        console.log('userWithProfile', userWithProfile)\n        if (userWithProfile.length > 0){\n            throw new Meteor.Error('403','No es posible elimiar el perfil',\n                'Hay al menos un usuario utilizando el perfil');\n        }\n    },\n    run({ idProfile }){\n        const responseMessage = new ResponseMessage();\n        try {\n                Profile.remove(idProfile);\n                responseMessage.create('Perfil eliminado exitosamente');\n        }catch (exception) {\n            console.error('profile.delete', exception);\n            throw new Meteor.Error('500', 'Ocurrio un error al eliminar el perfil');\n        }\n\n\n        return responseMessage;\n    }\n});"]},"sourceType":"module","hash":"aa839be38e4d75bd8d4d2b71e689f9a7df106d35"}
