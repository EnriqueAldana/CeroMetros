Base de datos Mongo MongoDB

Importacion mediante Mongo Tools

mongoimport --username root --password CeroM3tros --url=mongodb://jealdana.com:27017/zmeters?authSource=admin --collection=tosolicitud --type=csv --file=./Solicitudes_Enero2022.csv --mode=insert --ignoreBlanks
  
mongoimport --username root  \
            --password CeroM3tros  \
            --db tosolicitud \
            --collection tosolicitud \
            --type csv \ 
            --ignoreBlanks \
            --host jealdana.com  \
            --port 27017  \
            --columnsHaveTypes \
            --fields ["IdSolicitud.int32()","IdMaquina.int32()","IdUsuario.int32()","IdCaja.int32()","CantidadCaja.decimal()","CantidadTapa.decimal()","FechaSolicitud.date(2022-01-31 11:58:42)","FechaDespachoTotal.date(2022-01-31 11:58:42)","FechaDespachoParcial.date(2022-01-31 11:58:42)","FechaEspectativaDespacho.date(2022-01-31 11:58:42)","EstatusSolicitud.int32()","SurtidoEnDucto.string()","GrupoOperador.int32()","numordprod.int32()","TipoSolicitud.int32()","Medida.string()","Resistencia.string()","Borde.string()","Suministro.string()","SumTipo.string()","Actividad.string()","FechaPreSolicitud.date(2022-01-31 11:58:42)","UPDATE_TS.date(2022-01-31 11:58:42)"] \
            --file /Users/enrique/DiscoDeEnrique/2021/Proyectos/CeroMetros/database/CVS/Solicitudes_Enero2022.csv 
 
          

mongoimport --db=users --collection=contacts --type=csv \
   --columnsHaveTypes \
   --fields="name.string(),birthdate.date(2006-01-02),contacted.boolean(),followerCount.int32(),thumbnail.binary(base64)" \
   --file=/example/file.csv


Conexion Local
mongodb://localhost:27017/admin
Conexion PRODUCCION
mongodb://root:CeroM3tros@jealdana.com:27017/zmeters?authSource=admin

Conexion WEB mediante mongo-express
http://jealdana.com:8081/
Usuario: root
Contraseña: CeroM3tros

Fijar usuario a MongoDB
db.createUser({ user:"admin", pwd: "CeroM3tros", 
roles:["clusterAdmin","readAnyDatabase","readWriteAnyDatabase",
"userAdminAnyDatabase","dbAdminAnyDatabase"] });


Entrar a MongoDb como administradores
mongo localhost/admin -u admin -p

Script para agregar atributos a usuarios.

db.getCollection('users').update({status:{$exists:false}}, { $set:{status:{online:false}}},{multi:true})

Actualizacion de una columna mas  en Messages
db.getCollection('messages').update({read: {$exists: false}},{$set:{read: false}},{multi: true})

REESTABLECER BASE DE datos
mongorestore -u $MONGO_INITDB_ROOT_USERNAME -p $MONGO_INITDB_ROOT_PASSWORD --authenticationDatabase admin --db zmeters zmeters
mongorestore -u $MONGO_INITDB_ROOT_USERNAME -p $MONGOINITDB_ROOT_PASSWORD --authenticationDatabase admin --db zmeters zmeters
Desde PRODUCCION
1.- Traer los Backups a local
2.- Colocarse en el directorio
/Users/enrique/DiscoDeEnrique/2022/Proyectos/CeroMetros/Dump/backup-20220316_010001
mongorestore --db zmeters zmeters

En Windows
Nos posicionamos en el directorio del dump denominado
C:\IngeCompu\CeroMetrosWeb\CeroMetrosApp\CeroMetros\database\zmeters8Feb2022\dump>
Luego ejecutamos
C:\PROGRA~1\MongoDB\Tools\100\bin\mongorestore -d zmeters zmeters/
 
CONTRASEÑAS

Usuario root
Contraseña : SAbJOATs5Mm  // Esta es la contrasela que se usa 
            CeroM3tros  // Esta es la contraseña que se fijo cuando la imagen fue creada por primera vez.
                        // para reiniciar la contraseña se debe borrar el directorio data/db solo que se perderan todos los datos
            


DETALLES
asi mismo, hay otras cosilla que cambian del mongo nativo al mongo de meteor, 
por ejemplo, la parte de sort y limit. En Mongo nativo se maneja como: .find({}).sort({campo:1}).limit(4) 
y en Mongo de Meteor se maneja con el segundo parametro: .find({},{sort:[campo:1],limit:4})



hacer un backup
mongodump  --port 27017 --host localhost --username admin --password admin --authenticationDatabase=zmeters admin --db zmeters --out database/zmeters8Feb2022
mongodump --host="localhost" --port=27017
mongodump  --port 27017 --host localhost --username "" --password "" --authenticationDatabase=zmeters admin --db zmeters --out /
Remoto
mongodump --uri="mongodb://<host URL/IP>:<Port>" [additional options]

Problemas
// Si error Mongo code 96 hay que aumentar memoria para ordenamiento al servidor de 32MB a mas
            // Ejecutar en la ventana de comando de MongoDb
            // mongo -u "root" -p CeroM3tros --authenticationDatabase "admin"
            // db.adminCommand ({setParameter: 1, internalQueryExecMaxBlockingSortBytes: 335544320}) // No recomendado
            // Se debe obtener algo asi
            //db.adminCommand ({setParameter: 1, internalQueryExecMaxBlockingSortBytes: 335544320})
            // { "was" : 33554432, "ok" : 1 }

Manuales para consulta , Insercion y Actualizacion
https://guiadev.com/tutorial-de-mongodb-parte-02-sinaxtis-de-consultas/
Datos no repetidos
https://nelsoncode.medium.com/como-agregar-un-nuevo-campo-a-una-colección-en-mongodb-8bd756db5e29

Actualizar todos los registros con una nueva columna
https://www.iteramos.com/pregunta/25173/anadir-un-nuevo-campo-a-una-coleccion-en-mongodb

Administrar MongoDB
https://geekflare.com/es/mongodb-queries-examples/


Comparadores de consultas
https://docs.mongodb.com/manual/reference/operator/query-comparison/
For comparison of different BSON type values, see the specified BSON comparison order.

Name
Description
$eq
Matches values that are equal to a specified value.
$gt
Matches values that are greater than a specified value.
$gte
Matches values that are greater than or equal to a specified value.
$in
Matches any of the values specified in an array.
$lt
Matches values that are less than a specified value.
$lte
Matches values that are less than or equal to a specified value.
$ne
Matches all values that are not equal to a specified value.
$nin
Matches none of the values specified in an array.

Consulta rango de Fechas
{FechaSolicitud: { $gte: new Date('2022-01-01T00:00:00.000Z'), 
$lte: new Date('2022-01-31T23:59:59.000Z') } }

$and:[{u1:{$gt:30}},{u1:{$lt:60}}]}
{IdSolicitud: { $gte: 4109506, 
$lte: 4109993 } }

{$and: [{IdSolicitud:{$gte: 4109506}},{IdSolicitud:{$lte: 4109993}}]} 




Consultas ordenadas
db.getCollection('apm').find({}).sort( { dataCreated: -1 } )